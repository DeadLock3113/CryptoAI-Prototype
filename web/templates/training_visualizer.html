{% extends "layout.html" %}

{% block title %}Interactive Training Visualizer{% endblock %}

{% block head %}
{{ super() }}
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.3/font/bootstrap-icons.css">
{% endblock %}

{% block styles %}
<style>
    .training-container {
        background-color: var(--bs-dark);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 20px;
    }
    
    .training-status {
        font-size: 1.1rem;
        font-weight: 500;
        margin-bottom: 10px;
    }
    
    .model-params {
        background-color: var(--bs-gray-800);
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
    }
    
    .param-label {
        font-weight: bold;
        color: var(--bs-primary);
    }
    
    .control-panel {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
    }
    
    #stop-training-btn {
        min-width: 120px;
    }
    
    .metrics-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin-top: 20px;
    }
    
    .metric-card {
        background: var(--bs-gray-800);
        border-left: 4px solid var(--bs-primary);
        padding: 15px;
        border-radius: 5px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    .metric-card::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        height: 3px;
        width: 0;
        background: linear-gradient(90deg, var(--bs-primary), var(--bs-success));
        transition: width 0.5s ease;
    }
    
    .metric-card.updating::after {
        width: 100%;
        transition: width 0.8s ease-in-out;
    }
    
    .metric-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--bs-light);
        transition: color 0.3s ease;
    }
    
    .metric-value.changed {
        color: var(--bs-success);
    }
    
    .metric-label {
        font-size: 0.9rem;
        color: var(--bs-gray-400);
    }
    
    .metric-pulse {
        animation: pulse 1s ease-in-out;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    @media (max-width: 768px) {
        .chart-container {
            height: 300px;
        }
        
        .metrics-container {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Visualizzatore Interattivo Addestramento</h2>
                <a href="{{ url_for('models', dataset_id=dataset_id) }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Torna ai Modelli
                </a>
            </div>
            
            <div class="training-container" id="training-progress-container" data-training-id="{{ training_id }}">
                <div class="row">
                    <div class="col-md-8">
                        <h4 class="mb-3">{{ model_name }} - Progresso Addestramento</h4>
                        <div class="model-params">
                            <div class="row">
                                <div class="col-md-3 col-6">
                                    <div class="mb-2">
                                        <span class="param-label">Dataset:</span>
                                        <div>{{ dataset_name }}</div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="mb-2">
                                        <span class="param-label">Tipo:</span>
                                        <div>{{ model_type }}</div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="mb-2">
                                        <span class="param-label">Epoche:</span>
                                        <div>{{ epochs }}</div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="mb-2">
                                        <span class="param-label">Lookback:</span>
                                        <div>{{ lookback }}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-3 col-6">
                                    <div class="mb-2">
                                        <span class="param-label">Batch Size:</span>
                                        <div>{{ batch_size }}</div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="mb-2">
                                        <span class="param-label">Learning Rate:</span>
                                        <div>{{ learning_rate }}</div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="mb-2">
                                        <span class="param-label">Device:</span>
                                        <div>{{ device }}</div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="mb-2">
                                        <span class="param-label">Modalit√†:</span>
                                        <div>{{ 'Demo' if demo_mode else 'Completa' }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="mb-2 training-status-container">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="mb-0">Stato Addestramento</h5>
                                <button class="btn btn-sm btn-danger" id="stop-training-btn">
                                    <i class="bi bi-stop-circle"></i> Interrompi
                                </button>
                            </div>
                            <div class="training-status" id="training-status">Inizializzazione...</div>
                            <div class="progress bg-dark">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     id="training-progress-bar" 
                                     role="progressbar" 
                                     aria-valuenow="0" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100" 
                                     style="width: 0%">0%</div>
                            </div>
                        </div>
                        
                        <div class="metrics-container">
                            <div class="metric-card" style="border-color: var(--bs-primary);">
                                <div class="metric-value" id="current-epoch">0</div>
                                <div class="metric-label">Epoca Corrente</div>
                            </div>
                            <div class="metric-card" style="border-color: var(--bs-danger);">
                                <div class="metric-value" id="current-loss">-</div>
                                <div class="metric-label">Loss Corrente</div>
                            </div>
                            <div class="metric-card" style="border-color: var(--bs-info);">
                                <div class="metric-value" id="time-elapsed">0s</div>
                                <div class="metric-label">Tempo Trascorso</div>
                            </div>
                            <div class="metric-card" style="border-color: var(--bs-warning);">
                                <div class="metric-value" id="time-remaining">-</div>
                                <div class="metric-label">Tempo Rimanente</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="chart-container">
                            <canvas id="loss-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mt-4">
                <div class="col-md-6">
                    <div class="card bg-dark">
                        <div class="card-header bg-dark">
                            <h5 class="mb-0">Log Addestramento</h5>
                        </div>
                        <div class="card-body">
                            <div class="log-container bg-gray-800 p-3 rounded" style="height: 250px; overflow-y: auto;">
                                <pre id="training-log" class="text-light mb-0" style="font-size: 0.85rem;"></pre>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card bg-dark">
                        <div class="card-header bg-dark">
                            <h5 class="mb-0">Metriche di Prestazione</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-dark table-hover">
                                    <thead>
                                        <tr>
                                            <th>Metrica</th>
                                            <th>Valore</th>
                                            <th>Ultimo Update</th>
                                        </tr>
                                    </thead>
                                    <tbody id="metrics-table-body">
                                        <tr>
                                            <td>
                                                <span class="d-flex align-items-center">
                                                    <i class="bi bi-square-fill text-danger me-2"></i>
                                                    MSE
                                                    <span class="badge bg-secondary ms-2" data-bs-toggle="tooltip" title="Mean Squared Error - Misura la media dei quadrati degli errori">
                                                        <i class="bi bi-info-circle"></i>
                                                    </span>
                                                </span>
                                            </td>
                                            <td id="metric-mse">-</td>
                                            <td id="update-mse">-</td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <span class="d-flex align-items-center">
                                                    <i class="bi bi-square-fill text-warning me-2"></i>
                                                    RMSE
                                                    <span class="badge bg-secondary ms-2" data-bs-toggle="tooltip" title="Root Mean Squared Error - Radice quadrata dell'MSE, pi√π interpretabile">
                                                        <i class="bi bi-info-circle"></i>
                                                    </span>
                                                </span>
                                            </td>
                                            <td id="metric-rmse">-</td>
                                            <td id="update-rmse">-</td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <span class="d-flex align-items-center">
                                                    <i class="bi bi-square-fill text-info me-2"></i>
                                                    MAE
                                                    <span class="badge bg-secondary ms-2" data-bs-toggle="tooltip" title="Mean Absolute Error - Media degli errori assoluti">
                                                        <i class="bi bi-info-circle"></i>
                                                    </span>
                                                </span>
                                            </td>
                                            <td id="metric-mae">-</td>
                                            <td id="update-mae">-</td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <span class="d-flex align-items-center">
                                                    <i class="bi bi-square-fill text-success me-2"></i>
                                                    R¬≤
                                                    <span class="badge bg-secondary ms-2" data-bs-toggle="tooltip" title="Coefficiente di determinazione - Misura la qualit√† della previsione (0-1)">
                                                        <i class="bi bi-info-circle"></i>
                                                    </span>
                                                </span>
                                            </td>
                                            <td id="metric-r2">-</td>
                                            <td id="update-r2">-</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Bootstrap 5 Bundle con Popper.js (necessario per i tooltip) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.8.0/dist/chart.min.js"></script>
<!-- Training Visualizer Script -->
<script src="{{ url_for('static', filename='js/training-visualizer.js') }}"></script>
<script>
    // Helper per formattare i tempi
    function formatTime(seconds) {
        if (seconds < 60) {
            return `${Math.round(seconds)}s`;
        } else if (seconds < 3600) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.round(seconds % 60);
            return `${minutes}m ${remainingSeconds}s`;
        } else {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours}h ${minutes}m`;
        }
    }
    
    // Aggiornare le metriche visualizzate
    function updateMetrics(metrics) {
        if (!metrics) return;
        
        if (metrics.mse !== undefined) {
            document.getElementById('metric-mse').textContent = metrics.mse.toFixed(6);
            document.getElementById('update-mse').textContent = new Date().toLocaleTimeString();
        }
        
        if (metrics.rmse !== undefined) {
            document.getElementById('metric-rmse').textContent = metrics.rmse.toFixed(6);
            document.getElementById('update-rmse').textContent = new Date().toLocaleTimeString();
        }
        
        if (metrics.mae !== undefined) {
            document.getElementById('metric-mae').textContent = metrics.mae.toFixed(6);
            document.getElementById('update-mae').textContent = new Date().toLocaleTimeString();
        }
        
        if (metrics.r2 !== undefined) {
            document.getElementById('metric-r2').textContent = metrics.r2.toFixed(6);
            document.getElementById('update-r2').textContent = new Date().toLocaleTimeString();
        }
    }
    
    // Aggiornare i log di addestramento
    function appendToLog(message) {
        const logElement = document.getElementById('training-log');
        if (logElement) {
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
        }
    }
    
    // Ascoltare eventi personalizzati dal visualizzatore
    document.addEventListener('DOMContentLoaded', function() {
        // Inizializza i tooltip di Bootstrap
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
        
        // Gestione dell'aggiornamento delle metriche con effetti visivi
        document.querySelectorAll('.metric-card').forEach(card => {
            const metricValue = card.querySelector('.metric-value');
            if (metricValue) {
                const observer = new MutationObserver(mutations => {
                    mutations.forEach(mutation => {
                        if (mutation.type === 'childList') {
                            card.classList.add('updating');
                            setTimeout(() => {
                                card.classList.remove('updating');
                            }, 800);
                        }
                    });
                });
                
                observer.observe(metricValue, { childList: true });
            }
        });
        
        const eventSource = new EventSource('/training-progress/{{ training_id }}');
        
        eventSource.addEventListener('epoch_update', function(e) {
            const data = JSON.parse(e.data);
            // Utilizziamo la funzione animata per aggiornare i valori
            if (window.TrainingVisualizer && window.TrainingVisualizer.updateRealTimeMetrics) {
                window.TrainingVisualizer.updateRealTimeMetrics(data);
            } else {
                // Fallback per compatibilit√†
                document.getElementById('current-epoch').textContent = data.epoch;
                document.getElementById('current-loss').textContent = data.train_loss.toFixed(6);
                document.getElementById('time-elapsed').textContent = formatTime(data.elapsed_time);
                
                if (data.estimated_remaining_time) {
                    document.getElementById('time-remaining').textContent = formatTime(data.estimated_remaining_time);
                }
            }
            
            appendToLog(`Epoca ${data.epoch}/${data.total_epochs}: Train Loss=${data.train_loss.toFixed(6)}, Val Loss=${data.val_loss.toFixed(6)}`);
            
            if (data.metrics) {
                updateMetrics(data.metrics);
            }
        });
        
        eventSource.addEventListener('training_complete', function(e) {
            const data = JSON.parse(e.data);
            document.getElementById('time-elapsed').textContent = formatTime(data.total_time);
            document.getElementById('time-remaining').textContent = '0s';
            updateMetrics(data.metrics);
            appendToLog(`Addestramento completato! Loss finale: ${data.final_loss.toFixed(6)}`);
        });
        
        eventSource.addEventListener('training_error', function(e) {
            const data = JSON.parse(e.data);
            appendToLog(`ERRORE: ${data.error}`);
        });
    });
</script>
{% endblock %}